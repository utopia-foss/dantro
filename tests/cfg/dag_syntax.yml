# Syntax for the TransformationDAG
---
# -----------------------------------------------------------------------------
# Simple cases

simple_transform:
  params:
    select: ~
    transform:
      - operation: op0
        args:
          - one_arg
          - another_arg
        kwargs:
          some_kwarg: hello
        tag: res0

      - operation: op1
        args: []
        kwargs:
          some_kwarg: !dag_tag some_field
          another_kwarg: abc
        tag: res1

  expected:  
    - operation: op0
      args:
        - one_arg
        - another_arg
      kwargs:
        some_kwarg: hello
      tag: res0

    - operation: op1
      args: []
      kwargs:
        some_kwarg: !dag_tag some_field
        another_kwarg: abc
      tag: res1


minimal:
  params:
    select: ~
    transform:
      - operation: some_op_without_any_args_or_kwargs
      - operation: some_unary_op
        carry_result: true
      - invert

  expected:  
    - operation: some_op_without_any_args_or_kwargs
      args: []
      kwargs: {}
      tag: ~
    - operation: some_unary_op
      args:
        - !dag_node -1
      kwargs: {}
      tag: ~
    - operation: invert
      args:
        - !dag_node -1
      kwargs: {}
      tag: ~

# -----------------------------------------------------------------------------
# Shorthand for unary and binary operations

shorthand_transform:
  params:
    select: ~
    transform:
      - some_unary_op: [no_target]

      - some_unary_op: [!dag_prev ]
        tag: res0
      
      - some_unary_op_with_kwargs:
          some_kwarg: some_value
        tag: res1

      - some_binary_op: [!dag_tag some_field, 123]
        tag: res2

      - some_binary_op_with_kwargs:
          kwarg0: !dag_tag foo
          kwarg1: !dag_tag bar

  expected:
    - operation: some_unary_op
      args:
        - no_target
      kwargs: {}
      tag: ~

    - operation: some_unary_op
      args:
        - !dag_node -1
      kwargs: {}
      tag: res0

    - operation: some_unary_op_with_kwargs
      args: []
      kwargs:
        some_kwarg: some_value
      tag: res1

    - operation: some_binary_op
      args:
        - !dag_tag some_field
        - 123
      kwargs: {}
      tag: res2

    - operation: some_binary_op_with_kwargs
      args: []
      kwargs:
        kwarg0: !dag_tag foo
        kwarg1: !dag_tag bar
      tag: ~


# -----------------------------------------------------------------------------
# With select

simple_select:
  params:
    select:
      foo: some/path/foo
      bar: some/path/bar

    transform:
      - operation: some_operation
        args:
          - !dag_tag foo
        kwargs:
          some_kwarg: hey
        tag: spam
  
  expected:
    - operation: getitem
      args:
        - !dag_tag dm
        - some/path/bar
      kwargs: {}
      tag: bar
      file_cache:
        write: false
        read: false
    - operation: getitem
      args:
        - !dag_tag dm
        - some/path/foo
      kwargs: {}
      tag: foo
      file_cache:
        write: false
        read: false
    - operation: some_operation
      args:
        - !dag_tag foo
      kwargs:
        some_kwarg: hey
      tag: spam


select_with_transform:
  params:
    select:
      foo:
        path: some/path
        carry_result: true
        transform:
          - getitem: foo
      bar:
        path: some/path/bar
        transform:
          - some_operation: [!dag_prev , 1, 2, 3]
          - another_operation:
              input: !dag_prev
              one_kwarg: 1
              another_kwarg: abc
    transform: ~
  
  expected:
    - operation: getitem
      args:
        - !dag_tag dm
        - some/path/bar
      kwargs: {}
      tag: ~
      file_cache:
        write: false
        read: false
    - operation: some_operation
      args:
        - !dag_node -1
        - 1
        - 2
        - 3
      kwargs: {}
      tag: ~
    - operation: another_operation
      args: []
      kwargs:
        input: !dag_node -1
        one_kwarg: 1
        another_kwarg: abc
      tag: bar

    - operation: getitem
      args:
        - !dag_tag dm
        - some/path
      kwargs: {}
      tag: ~
      file_cache:
        write: false
        read: false
    - operation: getitem
      args:
        - !dag_node -1
        - foo
      kwargs: {}
      tag: foo

# -----------------------------------------------------------------------------
# Misc

salted:
  params:
    select:
      foo:
        path: some/path
        transform:
          - some_operation: foo
            salt: 42

    transform:
      - operation: another_operation
        carry_result: true
        args: []
        kwargs: {}
        salt: 43

  expected:
    - operation: getitem
      args:
        - !dag_tag dm
        - some/path
      kwargs: {}
      tag: ~
      file_cache:
        write: false
        read: false
    - operation: some_operation
      args:
        - foo
      kwargs: {}
      salt: 42
      tag: foo
    - operation: another_operation
      args:
        - !dag_prev
      kwargs: {}
      salt: 43
      tag: ~

# -----------------------------------------------------------------------------

file_cache_defaults:
  init_params:
    file_cache_defaults:
      write: true
      read: true
  params:
    select:
      foo: some/path/foo
      bar:
        path: some/path/bar
    transform:      
      - some_unary_op_with_kwargs:
          some_kwarg: some_value
        tag: res1
        file_cache:
          write: false
          read: false

      - some_binary_op: [!dag_tag some_field, 123]
        tag: res2
        file_cache:
          write:
            enabled: true
            always: true
          read:
            enabled: false

  expected:
    - operation: getitem
      args:
        - !dag_tag dm
        - some/path/bar
      kwargs: {}
      tag: bar
      file_cache:
        write: false
        read: false
    - operation: getitem
      args:
        - !dag_tag dm
        - some/path/foo
      kwargs: {}
      tag: foo
      file_cache:
        write: false
        read: false
    - operation: some_unary_op_with_kwargs
      args: []
      kwargs:
        some_kwarg: some_value
      tag: res1
      file_cache:
        write: false
        read: false

    - operation: some_binary_op
      args:
        - !dag_tag some_field
        - 123
      kwargs: {}
      tag: res2
      file_cache:
        write:
          enabled: true
          always: true
        read:
          enabled: false
