# Test cases for the TransformationsDAG
---
# Selecting items -------------------------------------------------------------
explicit_select:
  params:
    transform:
      - operation: getitem
        args:
          - !dag_tag dm
          - some/path
      - operation: getitem
        args:
          - !dag_node -1
          - foo
        tag: foo

      - operation: getitem
        args:
          - !dag_tag dm
          - some/path/bar
        tag: bar

  expected:
    num_nodes: 3
    num_objects: 4
    tags: [dm, foo, bar]
    node_hashes:
      - efed57fb39b65918df1919473aece2ef
      - 2bda662589177e9d1d39200f79e4d1e7
      - &getitem_bar 4328aed4085dc27fd5c5802df33e584f
    results: &results_explicit_select
      foo:
        type: LinkContainer
        linked_path: some/path/foo
        linked_type: OrderedDataGroup
        attributes:
          name: foo
      bar:
        type: LinkContainer
        linked_path: some/path/bar
        linked_type: OrderedDataGroup
        attributes:
          name: bar


shorthand_select:
  params:
    select:
      foo: some/path/foo
      bar: some/path/bar

  expected:
    num_nodes: 2
    num_objects: 3
    tags: [dm, foo, bar]
    node_hashes:
      - *getitem_bar  # comes first here because select orders by key first
      - ea8a716f69fc720a28c9b1b716f43191
    results:
      <<: *results_explicit_select


# Basic numerical operations --------------------------------------------------

explicit_increment:
  params:
    select:
      zero_raw: data/zeros
    transform:
      - operation: increment
        args:
          - !dag_tag zero_raw
        tag: ones

      - operation: increment
        args:
          - !dag_tag ones
        tag: twos

      - operation: decrement
        args:
          - !dag_tag ones
        tag: zeros

      - operation: .T
        args:
          - !dag_prev
        tag: zeros_T

      - operation: .T
        args:
          - !dag_tag zero_raw
        tag: zero_raw_T

      - operation: .T
        args:
          - !dag_tag zero_raw
        tag: zero_raw_T2  # basically a duplicate

  expected:
    num_nodes: 7
    num_objects: 7  # not 8! Due to the duplicate Transformation
    tags: [dm, zero_raw, ones, twos, zeros, zeros_T, zero_raw_T, zero_raw_T2]
    node_hashes:
      - 537b1c89ea418dc16bc8e957322bf539
      - 5e82e198c35e83d71a4f8f5f775b2c61
      - c2407e64963b57370d615f33445d246e
      - 7337d68eda9cd98491a06967776e3bf5
      - 6d2230f26117b65faa6fc403216b0a42
      - d36ff9e0437f7e2e2c1dcfe5d191f1ba
      - d36ff9e0437f7e2e2c1dcfe5d191f1ba  # from the duplicate
    results:
      zero_raw:
        type: LinkContainer
        linked_path: data/zeros
        linked_type: NumpyDataContainer
        attributes:
          name: zero_raw
          mean: 0.
          shape: [2,3,4]
      ones:
        type: NumpyDataContainer
        attributes:
          mean: 1.
          shape: [2,3,4]
      twos:
        type: NumpyDataContainer
        attributes:
          mean: 2.
          shape: [2,3,4]
      zeros:
        type: NumpyDataContainer
        attributes:
          mean: 0.
          shape: [2,3,4]
      zeros_T:
        type: NumpyDataContainer
        attributes:
          mean: 0.
          shape: [4,3,2]
      zero_raw_T: &results_zero_raw_T
        type: NumpyDataContainer
        attributes:
          mean: 0.
          shape: [4,3,2]
      zero_raw_T2:
        <<: *results_zero_raw_T        
