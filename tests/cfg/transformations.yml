# Test cases for the TransformationsDAG
---
# Selecting items -------------------------------------------------------------
explicit_select:
  params:
    transform:
      - operation: getitem
        args:
          - !dag_tag dm
          - some/path
      - operation: getitem
        args:
          - !dag_node -1
          - foo
        tag: foo

      - operation: getitem
        args:
          - !dag_tag dm
          - some/path/bar
        tag: bar

  expected:
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, foo, bar]
    node_hashes:
      - &hash_getitem_some_path 71ea378e3bd9836be6f62048ce496f9b
      - &hash_getitem_foo 620629222282c8cf227d40d85ad9d4be
      - &hash_getitem_some_path_bar 03892fe52e9e4f2031618c34ea72fa6b
    node_dependencies:
      - - &hash_dm 38518b2446b95e8834372949a8e9dfc2  # 0 -> DataManager
      - - *hash_getitem_some_path                    # 1 -> 1
      - - *hash_dm                                   # 2 -> DataManager
    cache_dir_available: false
    results: &results_explicit_select
      foo:
        type: OrderedDataGroup
        attributes:
          path: /TestDM/some/path/foo
          name: foo
      bar:
        type: OrderedDataGroup
        attributes:
          path: /TestDM/some/path/bar
          name: bar


shorthand_select:
  params:
    select:
      foo: some/path/foo
      bar:
        path: some/path/bar
        transform: []

  expected:
    num_nodes: 2
    num_objects: 4
    tags: [dag, dm, foo, bar]
    cache_dir_available: false
    node_hashes:
      - *hash_getitem_some_path_bar  # comes first b/c select orders by keys
      - afbb6c3f8ff0a7b9238e9fb44adcffad
    node_dependencies:
      - - *hash_dm
      - - *hash_dm
    results:
      <<: *results_explicit_select


# Nested arguments ------------------------------------------------------------

nested_args:
  params:
    transform:
      - define: [1]
        tag: one
      - define: [2]
        tag: two
      - dict:
          one: !dag_tag one
          two: !dag_tag two
          nested:
            one: [!dag_tag one]
            two: [!dag_tag two]
            three: [3]
          as_list: [!dag_tag one, !dag_tag two, 3]
          as_nested_list: [[!dag_tag one, 2, 3], [1, !dag_tag two, 3], [1,2,3]]
        tag: nested

  expected:
    results:
      nested:
        type: dict
        compare_to:
          one: 1
          two: 2
          nested:
            one: [1]
            two: [2]
            three: [3]
          as_list: [1, 2, 3]
          as_nested_list: [[1,2,3], [1,2,3], [1,2,3]]


# Custom selection base -------------------------------------------------------

custom_selection_base:
  params:
    base_transform:
      - getitem: [!dag_tag dm, some/path]
        tag: some_path
    select_base: some_path
    select:
      foo: foo
      bar:
        path: bar

  expected:
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, some_path, foo, bar]
    node_hashes:
      - *hash_getitem_some_path
      - 10370176270163776e01ec16e5d90ece
      - *hash_getitem_foo
    node_dependencies:
      - - *hash_dm
      - - *hash_getitem_some_path
      - - *hash_getitem_some_path
    cache_dir_available: false
    results:
      <<: *results_explicit_select

custom_selection_base_error_base_tag_not_found:
  params:
    base_transform:
      - getitem: [!dag_tag dm, some/path]
    select_base: some_path

  _raises: KeyError
  _match: "The tag 'some_path' cannot be the basis of future select operations because it is not available! .* Available tags: dag, dm"

# Basic numerical operations --------------------------------------------------

# The following is named "basic", but already shows off a wide range of the
# TransformationDAG functionality, including object management and caching ...
basic_numerical_ops:
  params:
    select:
      zero_raw: data/zeros
    transform:
      - operation: increment
        args:
          - !dag_tag zero_raw
        tag: ones

      - operation: increment
        args:
          - !dag_tag ones
        tag: twos

      - operation: decrement
        args:
          - !dag_tag ones
        tag: zeros

      - operation: .T
        args:
          - !dag_prev
        tag: zeros_T

      - operation: .T
        args:
          - !dag_tag zero_raw
        tag: zero_raw_T

      - operation: .T
        args:
          - !dag_tag zero_raw
        tag: zero_raw_T2  # ... a duplicate of 'zero_raw_T' (except the tag)

    file_cache_defaults:
      write:
        enabled: true

  expected:
    num_nodes: 7
    num_objects: 8  # not 9! Due to the duplicate Transformation
    tags: [dag, dm, zero_raw, ones, twos, zeros, zeros_T, zero_raw_T, zero_raw_T2]
    node_hashes:
      - &hash_select_zero_raw f5cf9fae283a3f238e01bbb1fafa526a
      - &hash_increment_zeros 076b2b4327007ffa4e026535faa679cb
      - c6da8091d31d79cb05cac40efa7b61b2
      - e864462dd218adb94310403d844e2d97
      - 7e0ef51c35dcac205efec47714558b09
      - &hash_zero_raw_T 9887dfa06629707da377ab2dc7bed91b
      - *hash_zero_raw_T # from the duplicate transformation
    node_dependencies:
      - - *hash_dm
      - - *hash_select_zero_raw
      - - *hash_increment_zeros
      - 1
      - 1
      - 1
      - 1
    cache_dir_available: true
    cache_files:
      # - f5cf9fae283a3f238e01bbb1fafa526a.npy  # not cached (from select)
      - 076b2b4327007ffa4e026535faa679cb.npy
      - c6da8091d31d79cb05cac40efa7b61b2.npy
      - e864462dd218adb94310403d844e2d97.npy
      - 7e0ef51c35dcac205efec47714558b09.npy
      - 9887dfa06629707da377ab2dc7bed91b.npy
    results:
      zero_raw:
        type: NumpyDataContainer
        attributes:
          path: /TestDM/data/zeros
          name: zeros
          mean: 0.
          shape: [2,3,4]
      ones:
        type: NumpyDataContainer
        attributes:
          path: /076b2b43
          mean: 1.
          shape: [2,3,4]
      twos:
        type: NumpyDataContainer
        attributes:
          path: /c6da8091
          mean: 2.
          shape: [2,3,4]
      zeros:
        type: NumpyDataContainer
        attributes:
          path: /e864462d
          mean: 0.
          shape: [2,3,4]
      zeros_T:
        type: ndarray
        attributes:
          mean: 0.
          shape: [4,3,2]
      zero_raw_T: &results_zero_raw_T
        type: ndarray
        attributes:
          mean: 0.
          shape: [4,3,2]
      zero_raw_T2:
        <<: *results_zero_raw_T


binary_ops:
  params:
    select:
      zero_raw: data/zeros
      random_raw: data/random
    transform:
      - operation: add
        args:
          - !dag_tag zero_raw
          - !dag_tag random_raw
        tag: zero_plus_rand

  expected:
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, zero_raw, random_raw, zero_plus_rand]
    node_hashes:
      - &hash_select_random 2c328940238bcfc27b09a0f3fd6b0c43
      - *hash_select_zero_raw
      - 9314f70f80483258dd1feb28127d659a
    node_dependencies:
      - - *hash_dm
      - - *hash_dm
      - - *hash_select_zero_raw
        - *hash_select_random
    cache_dir_available: false


duplicates_and_salted:
  params:
    select:
      zero_raw: data/zeros
    transform:
      - operation: increment
        args:
          - !dag_tag zero_raw
        tag: ones
      
      - operation: increment
        args:
          - !dag_tag zero_raw
        tag: also_ones

      - operation: increment
        args:
          - !dag_tag zero_raw
        tag: also_ones_but_salted
        salt: 123

  expected:
    num_nodes: 4
    num_objects: 5  # due to one duplicate transformation
    tags: [dag, dm, zero_raw, ones, also_ones, also_ones_but_salted]
    node_hashes:
      - *hash_select_zero_raw
      - *hash_increment_zeros
      - *hash_increment_zeros
      - 050b5d5143ac27917b39ba264dcbed96  # ... due to being salted


compute_only_a_subset:
  params:
    select:
      zero_raw: data/zeros
    transform:
      - operation: increment
        args:
          - !dag_tag zero_raw
        tag: ones

      - operation: increment
        args:
          - !dag_tag ones
        tag: twos

  compute_only: [zero_raw, twos]
  expected:
    computed_tags: [zero_raw, twos]


# Caching tests ---------------------------------------------------------------

numpy_and_xarray_data:
  cache_dir_name: &shared_cache_dir shared_cache_dir
  params:
    file_cache_defaults:
      read: true  # ... but there is nothing
      write:
        enabled: true
        storage_options:
          raise_on_error: true

    select:
      zeros_raw: labelled_data/zeros
      random_raw: labelled_data/random

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones

  expected: 
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, zeros_raw, random_raw, ones]
    node_hashes:
      - &hash_select_random_raw 759cee3ffa7229efb546ff361b0a68c7
      - &hash_select_zeros_raw 73e14453d5cc87c8df48483d5d2d7498
      - &hash_op_increment_zeros_raw 7e79449d444947d40e71692f369e674a
    cache_dir_available: true
    cache_files:
      # ... only the result
      - 7e79449d444947d40e71692f369e674a.xrdc

numpy_and_xarray_data_2nd_run:
  cache_dir_name: *shared_cache_dir
  params:
    file_cache_defaults:
      # read, don't write
      read: true
      write: false

    select:
      zeros_raw: labelled_data/zeros

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones
      - getitem: [!dag_tag dm, cache/dag/7e79449d444947d40e71692f369e674a]
        tag: ones_tree
  
  expected:
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, zeros_raw, ones, ones_tree]
    cache_dir_available: true
    cache_files:
      - 7e79449d444947d40e71692f369e674a.xrdc

numpy_and_xarray_data_3rd_run:
  cache_dir_name: *shared_cache_dir
  params:
    file_cache_defaults:
      # Read but still overwrite existing file
      read: true
      write:
        enabled: true
        allow_overwrite: true

    select:
      zeros_raw: labelled_data/zeros

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones
  
  expected:
    num_nodes: 2
    num_objects: 4
    tags: [dag, dm, zeros_raw, ones]
    cache_dir_available: true
    cache_files:
      - 7e79449d444947d40e71692f369e674a.xrdc

file_cache_pickle_data:
  params:
    select:
      some_dict: objects/some_dict

    transform:
      - operation: getattr
        args: [!dag_tag some_dict, _data]
        tag: dict_data
        file_cache:
          write: true

  expected:
    num_nodes: 2
    num_objects: 4
    tags: [dag, dm, some_dict, dict_data]
    cache_dir_available: true
    cache_files:
      - 517aa192889620e736352b7d33fe24c4.pkl


file_cache_kwargs_to_transformation:
  params:
    file_cache_defaults:
      write:
        enabled: false

    select:
      zeros_raw: labelled_data/zeros

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones
      - increment: [!dag_tag ones]
        tag: twos
        file_cache:
          write:
            enabled: true
            always: true

  expected: 
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, zeros_raw, ones, twos]
    node_hashes:
      - *hash_select_zeros_raw
      - *hash_op_increment_zeros_raw
      - cdb004fbea6e4da577301f1b7985bc98
    cache_dir_available: true
    cache_files:
      - cdb004fbea6e4da577301f1b7985bc98.xrdc  # tag twos

file_cache_kwargs_to_select:
  params:
    file_cache_defaults:
      read: true
      write: false

    select:
      zeros_raw: labelled_data/zeros
      random_plus_minus:
        path: labelled_data/random
        transform:
          - increment
          - decrement: []
            with_previous_result: true
            file_cache:
              write: true

    transform: []

  expected: 
    num_nodes: 4
    num_objects: 6
    tags: [dag, dm, zeros_raw, random_plus_minus]
    node_hashes:
      - *hash_select_random_raw
      - 0f5f1fe69721f3e1a3fb973e355e1eb9
      - 78f1151fc5c054f6f36cd89da74026a9
      - *hash_select_zeros_raw
    cache_dir_available: true
    cache_files:
      - 78f1151fc5c054f6f36cd89da74026a9.xrdc  # random after decrement


file_cache_object_size:
  params:
    file_cache_defaults:
      write:
        enabled: true
        min_size: 1048576  # 1M >> labelled_data/zeros

    select:
      zeros_raw: labelled_data/zeros

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones
      - increment: [!dag_tag ones]
        tag: twos
        file_cache:
          write:
            min_size: 1

  expected: 
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, zeros_raw, ones, twos]
    node_hashes:
      - *hash_select_zeros_raw
      - *hash_op_increment_zeros_raw
      - cdb004fbea6e4da577301f1b7985bc98
    cache_dir_available: true
    cache_files:
      - cdb004fbea6e4da577301f1b7985bc98.xrdc  # tag twos

file_cache_min_compute_time:
  params:
    file_cache_defaults:
      write:
        enabled: true
        min_compute_time: 42.
        # much larger than actual compute time

    select:
      zeros_raw: labelled_data/zeros

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones
      - increment: [!dag_tag ones]
        tag: twos
        file_cache:
          write:
            min_compute_time: 0.
            min_cumulative_compute_time: ~

  expected: 
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, zeros_raw, ones, twos]
    node_hashes:
      - *hash_select_zeros_raw
      - *hash_op_increment_zeros_raw
      - cdb004fbea6e4da577301f1b7985bc98
    cache_dir_available: true
    cache_files:
      - cdb004fbea6e4da577301f1b7985bc98.xrdc  # tag twos

file_cache_min_cumulative_compute_time:
  params:
    file_cache_defaults:
      write:
        enabled: true
        min_cumulative_compute_time: 42.

    select:
      zeros_raw: labelled_data/zeros

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones
      - increment: [!dag_tag ones]
        tag: twos
        file_cache:
          write:
            min_cumulative_compute_time: 0.

  expected: 
    num_nodes: 3
    num_objects: 5
    tags: [dag, dm, zeros_raw, ones, twos]
    node_hashes:
      - *hash_select_zeros_raw
      - *hash_op_increment_zeros_raw
      - cdb004fbea6e4da577301f1b7985bc98
    cache_dir_available: true
    cache_files:
      - cdb004fbea6e4da577301f1b7985bc98.xrdc  # tag twos

file_cache_invariant_hash:
  params:
    select:
      zeros_raw: labelled_data/zeros

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones_v1
        file_cache:
          write: false
          read: false
      - increment: [!dag_tag zeros_raw]
        tag: ones_v2
        file_cache:
          write: true
      - increment: [!dag_tag zeros_raw]
        tag: ones_v3
        file_cache:
          foo: bar  # ... is ignored! Which is intentional
      - increment: [!dag_tag zeros_raw]
        tag: ones_v4
        salt: 123
        file_cache:
          read: true

  expected: 
    num_nodes: 5
    num_objects: 5
    tags: [dag, dm, zeros_raw, ones_v1, ones_v2, ones_v3, ones_v4]
    node_hashes:
      - *hash_select_zeros_raw
      - *hash_op_increment_zeros_raw
      - *hash_op_increment_zeros_raw
      - *hash_op_increment_zeros_raw
      - f6ed8b556b3ec814b4c72b3810bbc2a2
    cache_dir_available: false


file_cache_file_already_loaded:
  # Use the shared cache to lead to a 
  cache_dir_name: *shared_cache_dir
  params:
    file_cache_defaults:
      # read and overwrite
      read:
        enabled: true
        load_options:
          exists_action: raise
      write:
        enabled: true
        allow_overwrite: true

    select:
      zeros_raw: labelled_data/zeros

    transform:
      - increment: [!dag_tag zeros_raw]
        tag: ones

  _raises: Exception
  _raises_on_compute: true
  _match: Path 'cache/dag/7e79449d444947d40e71692f369e674a' already exists.


file_cache_error_attempting_dm_select_cache:
  params:
    select:
      zeros_raw:
        path: labelled_data/zeros
        file_cache:
          write: true
    transform: ~

  _raises: ValueError
  _match: For selection from the selection base, the file cache is always disabled.


file_cache_error_writing_groups:
  params:
    transform:
      - operation: getitem
        args: [!dag_tag dm, some/path]
        tag: some_group
        file_cache:
          write: true

      - operation: getitem
        args: [!dag_tag dm, labelled_data]
        tag: some_group_to_be_cached
        file_cache:
          read: false
          write:
            enabled: true
            always: true
            storage_options:
              ignore_groups: false

  _raises: NotImplementedError
  _raises_on_compute: true
  _match: Cannot currently write dantro groups .* transformation resulting .*

file_cache_error_pickling:
  params:
    transform:
      - operation: getitem
        args: [!dag_tag dm, objects/some_list]
        tag: some_list
        file_cache:
          write:
            enabled: true
            storage_options:
              attempt_pickling: false
              raise_on_error: true
      
      - operation: getitem
        args: [!dag_tag dm, objects/some_dict]
        tag: some_dict
        file_cache:
          write:
            enabled: true
            storage_options:
              raise_on_error: false

      - operation: getitem
        args: [!dag_tag dm, objects/some_func]
        tag: some_func
        file_cache:
          write:
            enabled: true
            storage_options:
              raise_on_error: true

  _raises: RuntimeError
  _raises_on_compute: true
  _match: Failed saving transformation cache file. .* 'some_func'.*


file_cache_error_in_save_func:
  params:
    transform:
      - operation: getitem
        args: [!dag_tag dm, labelled_data/zeros]
        tag: zeros
        file_cache:
          write:
            enabled: true
            always: true
            storage_options:
              raise_on_error: false
              some_invalid_argument: asdf
      - operation: getitem
        args: [!dag_tag dm, labelled_data/random]
        tag: random
        file_cache:
          write:
            enabled: true
            always: true
            storage_options:
              raise_on_error: true
              some_invalid_argument: asdf

  _raises: RuntimeError
  _raises_on_compute: true
  _match: Failed saving transformation cache file .* Additional keyword arg.*


# Errors ----------------------------------------------------------------------

error_tag_already_exists:
  params:
    select:
      zero_raw: data/zeros
      random_raw: data/random
    transform:
      - operation: add
        args:
          - !dag_tag zero_raw
          - !dag_tag random_raw
        tag: random_raw
  _raises: ValueError
  _match: Tag 'random_raw' already exists! Choose a different one.


# Examples in documentation ---------------------------------------------------


doc_examples_with_previous_result:
  params:
    transform:
      - operation: mul
        args: [1, 2]
      - operation: mul
        args: [3]
        with_previous_result: true
      - operation: mul
        args: [4]
        with_previous_result: true
      - operation: mul
        args: [5]
        with_previous_result: true
        tag: f5

doc_examples_dag_prev:
  params:
    transform:
      - operation: define
        args: [10]
      - operation: sub
        args: [0, !dag_prev ]
      - operation: div
        args: [1, !dag_prev ]
      - operation: power
        args: [10, !dag_prev ]
        tag: my_result

doc_examples_select:
  params:
    select:
      some_data: path/to/some_data
      more_data:
        path: path/to/more_data
    transform: ~

  expected:
    tags: [dag, dm, some_data, more_data]

doc_examples_select_with_transform:
  params:
    select:
      square_increment:
        path: path/to/some_data
        with_previous_result: true
        transform:
          - operation: squared
          - operation: increment
      some_sum:
        path: path/to/more_data
        transform:
          - operation: getattr
            args: [!dag_prev , data]
          - operation: sub
            args: [0, !dag_prev ]
          - operation: .sum
            args: [!dag_prev ]
    transform:
      - operation: add
        args: [!dag_tag square_increment, !dag_tag some_sum ]
        tag: my_result

doc_examples_minimal:
  params:
    select:
      some_data: path/to/some_data
      more_data: path/to/more_data
    transform:
      - add: [!dag_tag some_data, !dag_tag more_data]
      - increment
      - print
      - power: [!dag_prev , 4]
        tag: my_result

  expected:
    tags: [dag, dm, some_data, more_data, my_result]
